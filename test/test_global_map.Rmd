---
title: "Testing Leaflet Plot of Global Map"
author: "Iwen Su"
output: html_document
---

# Setup
```{r, message=FALSE,warning=FALSE}

library(tidyverse)
library(rgdal)
library(leaflet)
library(here)
library(RColorBrewer)
library(sf)
library(rworldmap)
library(leaflet.minicharts)

setwd(here())
source("global.R")

## Define color palette
ygb <- colorRampPalette(brewer.pal(5,'YlGnBu'))(200); cols <- ygb[19:200]

```

# Test Global Mariculture Map

## Read in Global Countries Shapefile 
```{r}

# Super roundabout way of extracting country and lat lon info lol.
# Add global countries spatial information to dataset
global_shp <- joinCountryData2Map(shrimp_gather, joinCode = "NAME" , nameJoinColumn = "COUNTRY_NAME")

# Take subset and covert to sf object for easier manipulation
cntry_coord <- global_shp@data[,c(17,31,32)] %>% 
  rename(COUNTRY_NAME = NAME)

write.csv(cntry_coord, "data/country_lat_lon.csv")

# cntry_spatial <- st_as_sf(cntry_coord, coords = c("LON", "LAT"), crs = 4326) %>% 
#   rename(COUNTRY_NAME = NAME) %>% 
#   mutate(COUNTRY_NAME = as.character(COUNTRY_NAME))

```

## Identify arguments for map_card
```{r}
# data = mar_global_map
# filter_field = data$type
# display_field = "map_data"
# color_palette = ygb
# legend_title = "Legend"
# popup_title = "Seafood Production: "
# popup_units = "pounds/person"
# popup_add_field = "rgn_nam"
# popup_add_field_title = "EEZ: "

```

## Attach data to rgn shapefile

Check for countries that didn't get a lat/lon match. 
```{r}

# Combine lat lon info with shrimp data.
shrimp_spatial <- shrimp_summ %>% 
  left_join(cntry_coord, by = "COUNTRY_NAME")

# South Korea, Cote d'Ivoire, and UAE didn't get matched. Fix some in cntry_coord and in shrimp_spatial as appropriate
DT::datatable(shrimp_spatial)

```

Select for just 2018 data and 4 refusal reasons to test
```{r}

data_shp <- shrimp_spatial %>%
  filter(YEAR == 2018)

data_shp <- data_shp[, colSums(data_shp != 0) > 0] %>% 
  select(YEAR, COUNTRY_NAME, LAT, LON, SALMONELLA, VETDRUGES, NITROFURAN, FILTHY) %>% 
  mutate(TOTAL = SALMONELLA + VETDRUGES + NITROFURAN + FILTHY)

```

## Specify Attributes
```{r}
# # Get color pal
# pal <- colorQuantile(palette = color_palette,
#                      domain = data_shp$map_data,
#                      na.color = "#00000000",
#                      alpha = 0.4)
# 
# 
# ## Popup attributes
# popup_title = "Seafood Production: "
# popup_add_field_title = "Country EEZ: "
# 
# popup_text <- paste("<h5><strong>", popup_title, "</strong>", as.character(signif(data_shp$map_data,3)), "lb/person", "</h5>",
#                     "<h5><strong>", popup_add_field_title, "</strong>", data_shp$rgn_nam, "</h5>", sep=" ")
# 
# #prettyNum(data_shp$map_data, big.mark=",", scientific=FALSE)
```

## Plot with leaflet!

```{r}

col = ygb[c(50,100,150,197)]

leaflet(options = leafletOptions(zoomControl = FALSE)) %>%
  # addPolygons(color = "#A9A9A9", 
  #             weight = 0.5, 
  #             smoothFactor = 0.5,
  #             opacity = 1.0, 
  #             fillOpacity = 1.0,
  #             fillColor = ~pal(map_data),
  #             popup = popup_text, 
  #             highlightOptions = highlightOptions(color = "white", 
  #                                                 weight = 2,
  #                                                 bringToFront = TRUE)) %>% 
  # addLegend("bottomright",
  #           pal = pal,
  #           values = ~map_data,
  #           title = legend_title,
  #           opacity = 1,
  #           layerId = "colorLegend") %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  setView(-9.718568, 34.331989, zoom = 2) %>% 
  addMinicharts(
    data_shp$LON, data_shp$LAT,
    type = "pie",
    chartdata = data_shp[, c("SALMONELLA", "VETDRUGES", "NITROFURAN", "FILTHY")], 
    colorPalette = col, 
    width = 60 * sqrt(data_shp$TOTAL) / sqrt(max(data_shp$TOTAL)),
    transitionTime = 0)
 
#   addMinicharts(data_shp$LON, data_shp$LAT,
#                 type = "pie",
#                 chartdata = data_shp[,c(3,4,5)],
#                 colorPalette = ygb[1:])

```

Testing Legend Customization
```{r}
leaflet(data_shp,
        options = leafletOptions(zoomControl = FALSE)) %>%
  addPolygons(color = "#A9A9A9", 
              weight = 0.5, 
              smoothFactor = 0.5,
              opacity = 1.0, 
              fillOpacity = 0.7,
              fillColor = ~pal(map_data),
              popup = popup_text, 
              highlightOptions = highlightOptions(color = "white", 
                                                  weight = 2,
                                                  bringToFront = TRUE)) %>% 
  addLegend("bottomright",
            pal = pal,
            values = ~map_data,
            title = legend_title,
            opacity = 1,
            labFormat = labelFormat(
              prefix = "(", 
              suffix = ")%", 
              between = ", ",
              transform = identity
              )
            ) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
      setView(-9.718568, 34.331989, zoom = 2)
```

***

## Filter for Seaweed in `mar_global_map`
```{r}

mar_global_map <- read.csv("int/mar_global_map.csv")

country <- mar_global_map %>% select(rgn_id,country) %>% distinct() %>% mutate(type = "prodPerCap")
mar_global_map <- mar_global_map %>% 
  filter(Taxon == "Seaweed") %>% 
  full_join(country, by = c("rgn_id", "country","type"))

```

